<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Tasks - Toggle View</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <style>
    body, html { margin: 0; padding: 0; }
    :root {
      --bg-light: #f0f0f0; --bg-dark: #1e1e1e;
      --text-light: #000;  --text-dark: #fff;
      --border:   #ccc;    --accent:     green;
    }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: var(--bg-light);
      color: var(--text-light);
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.8em;
    }
    .date-label {
      text-align: center;
      font-size: 1.2em;
      margin-bottom: 20px;
    }
    .view-toggle {
      text-align: center;
      margin-bottom: 20px;
      display: none;
    }
    .view-toggle label {
      font-size: 0.9em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      padding: 12px;
      text-align: center;
      border: 1px solid var(--border);
    }
    th {
      background: #eee;
      font-size: 1em;
    }
    body.dark th {
      background: #333;
      color: var(--text-dark);
    }
    .task {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
    }
    .timer {
      font-size: 0.9em;
      color: #c00;
    }
    .set-timer-btn,
    .view-toggle input,
    button {
      font-size: 0.9em;
      padding: 4px 8px;
      margin-left: 4px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .approved {
      color: var(--accent);
      font-weight: bold;
    }
    .priority-High   { background-color: red;    color: white; padding: 4px 8px; border-radius: 4px; }
    .priority-Medium { background-color: yellow; color: black; padding: 4px 8px; border-radius: 4px; }
    .priority-Low    { background-color: green;  color: white; padding: 4px 8px; border-radius: 4px; }
    .priority-select { font-size: 0.9em; }
    .weather-alert,
    .recycling-note,
    .garbage-note {
      font-size: 1em;
      text-align: center;
      margin: 10px 0;
    }
    .theme-switch {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
    }
    .theme-switch input { display: none; }
  </style>
</head>
<body>
  <h1>Family Tasks</h1>
  <div class="date-label" id="dateLabel"></div>

  <!-- Parent-only view toggle -->
  <div class="view-toggle" id="viewToggleSection">
    <label>
      <input type="checkbox" id="view-toggle-checkbox"> Show Full View
    </label>
  </div>

  <!-- Theme toggle -->
  <label class="theme-switch">
    <input type="checkbox" id="toggle-checkbox" onchange="toggleTheme()">
    <span id="mode-label">ğŸŒ™ Dark Mode</span>
  </label>

  <table>
    <thead>
      <tr>
        <th>Day</th>
        <th>Jacob</th>
        <th>Jalyna</th>
        <th>Josh</th>
        <th>Jeremy</th>
      </tr>
    </thead>
    <tbody id="chore-body"></tbody>
  </table>

  <div class="weather-alert" id="weatherAlert">Loading weather...</div>
  <div class="recycling-note" id="recyclingNote">Loading recycling info...</div>
  <div class="garbage-note">
    ğŸ—‘ï¸ <strong>Garbage Instructions:</strong> Must be out by 9:00 PM night before pickup.
  </div>

  <div style="text-align:center; margin-top:20px;">
    <button onclick="rotateChores()">ğŸ” Rotate</button>
    <button onclick="reverseChores()">ğŸ”„ Reverse</button>
    <button onclick="resetAllTasks()">â®ï¸ Reset</button>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA6hkZDTQrqhS6Wcm9z8ADm5It-wck7U8",
      authDomain: "chores-c86f4.firebaseapp.com",
      databaseURL: "https://chores-c86f4-default-rtdb.firebaseio.com",
      projectId: "chores-c86f4",
      storageBucket: "chores-c86f4.appspot.com",
      messagingSenderId: "503520134350",
      appId: "1:503520134350:web:0ce4fc7c3c011eaa0cbc9f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const isParent = new URLSearchParams(window.location.search).get("user") === "parent";

    let chores = {}, taskStatuses = {}, timers = {}, priorities = {};
    const prioritiesRef = db.ref("priorities");
    let fullView = false;

    function toggleTheme() {
      document.body.classList.toggle("dark");
      const dark = document.body.classList.contains("dark");
      document.getElementById("mode-label").textContent = dark ? "â˜€ï¸ Light Mode" : "ğŸŒ™ Dark Mode";
      document.getElementById("toggle-checkbox").checked = dark;
    }

    function rotateChores() {
      if (!isParent) return;
      if (!confirm("Rotate all tasks among Jacob, Jalyna, and Josh?")) return;
      const rotateKids = ["Jacob", "Jalyna", "Josh"];
      const staticKids = ["Jeremy"];
      const newChores = {};
      for (let day in chores) {
        newChores[day] = {};
        rotateKids.forEach((kid, i) => {
          const next = rotateKids[(i + 1) % rotateKids.length];
          newChores[day][next] = chores[day][kid] || [];
        });
        staticKids.forEach(name => {
          newChores[day][name] = chores[day][name] || [];
        });
      }
      db.ref("weeklyChores").set(newChores)
        .then(() => alert("Tasks rotated among Jacob, Jalyna, and Josh."))
        .catch(err => alert("Rotation failed: " + err));
    }

    function reverseChores() {
      if (!isParent) return;
      if (!confirm("Reverse the last task rotation among Jacob, Jalyna, and Josh?")) return;
      const rotateKids = ["Jacob", "Jalyna", "Josh"];
      const staticKids = ["Jeremy"];
      const newChores = {};
      for (let day in chores) {
        newChores[day] = {};
        rotateKids.forEach((kid, i) => {
          const prev = rotateKids[(i - 1 + rotateKids.length) % rotateKids.length];
          newChores[day][kid] = chores[day][prev] || [];
        });
        staticKids.forEach(name => {
          newChores[day][name] = chores[day][name] || [];
        });
      }
      db.ref("weeklyChores").set(newChores)
        .then(() => alert("Tasks reversed."))
        .catch(err => alert("Reversal failed: " + err));
    }

    function resetAllTasks() {
      if (!isParent) return;
      if (confirm("Reset all tasks?")) {
        db.ref("tasks").remove();
        location.reload();
      }
    }

    function formatTimeLeft(ms) {
      const sec = Math.max(0, Math.floor(ms / 1000));
      const h = Math.floor(sec / 3600),
            m = Math.floor((sec % 3600) / 60),
            s = sec % 60;
      return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
    }

    function updateTimerDisplays() {
      const now = Date.now();
      for (let id in timers) {
        const span = document.getElementById(`${id}-timer`);
        if (!span) continue;
        const left = timers[id] - now;
        span.textContent = left > 0 ? `â³ ${formatTimeLeft(left)}` : "";
      }
    }

    function setTaskTimer(id) {
      if (!isParent) return;
      const mins = parseInt(prompt("Set timer in minutes:"));
      if (mins > 0) db.ref("timers/" + id).set(Date.now() + mins * 60000);
      else alert("Please enter a valid number.");
    }

    function syncTask(id, status) {
      db.ref("tasks/" + id).set(status);
    }

    function updateTaskUI(id, status) {
      const cb = document.getElementById(`${id}-checkbox`);
      const st = document.getElementById(`${id}-status`);
      const btn = document.getElementById(`${id}-approve`);
      if (!cb || !st) return;
      if (status === "approved") {
        cb.checked = true; cb.disabled = true;
        st.textContent = "âœ… Approved"; st.classList.add("approved");
        if (btn) btn.style.display = "none";
      } else if (status === "pending") {
        cb.checked = true; cb.disabled = false;
        st.textContent = "Pending";
        if (btn && isParent) btn.style.display = "inline-block";
        else if (btn) btn.style.display = "none";
      } else {
        cb.checked = false; cb.disabled = false;
        st.textContent = "";
        if (btn) btn.style.display = "none";
      }
    }

    function toggleTask(cb, id) {
      const s = cb.checked ? "pending" : "";
      syncTask(id, s);
      updateTaskUI(id, s);
    }

    function approveTask(id) {
      if (!isParent) return;
      syncTask(id, "approved");
      updateTaskUI(id, "approved");
    }

    function renderTodayChores() {
      const tb = document.getElementById("chore-body");
      const now = new Date();
      const todayName = now.toLocaleDateString('en-US', { weekday: 'long' });
      const fullDate = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      document.getElementById("dateLabel").textContent = `${todayName}, ${fullDate}`;
      tb.innerHTML = "";

      const tr = document.createElement("tr");
      tr.classList.add("task-row");
      const tdDay = document.createElement("td");
      tdDay.textContent = todayName;
      tr.appendChild(tdDay);

      ["Jacob","Jalyna","Josh","Jeremy"].forEach(name => {
        const td = document.createElement("td");
        const list = chores[todayName]?.[name] || [];
        if (!list.length) {
          td.innerHTML = "<em>Free</em>";
        } else {
          list.forEach((task, i) => {
            const id = `${name.toLowerCase()}-${todayName.toLowerCase()}-${i}`;
            const dv = document.createElement("div");
            dv.className = "task";

            // Priority
            const prio = priorities[id] || "Medium";
            dv.classList.add(`priority-${prio}`);

            // Checkbox + label
            const lb = document.createElement("label");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.id = `${id}-checkbox`;
            cb.onchange = () => toggleTask(cb, id);
            lb.append(cb, document.createTextNode(task));

            // Priority selector
            const sel = document.createElement("select");
            sel.className = "priority-select";
            ["Low","Medium","High"].forEach(level => {
              const opt = document.createElement("option");
              opt.value = level;
              opt.textContent = level;
              if (level === prio) opt.selected = true;
              sel.append(opt);
            });
            sel.onchange = () => prioritiesRef.child(id).set(sel.value);

            // Timer + status
            const ts = document.createElement("span");
            ts.id = `${id}-timer`;
            ts.className = "timer";
            const ss = document.createElement("span");
            ss.id = `${id}-status`;

            dv.append(lb, sel, ts, ss);

            if (isParent) {
              const ap = document.createElement("button");
              ap.id = `${id}-approve`;
              ap.textContent = "Approve";
              ap.style.display = "none";
              ap.onclick = () => approveTask(id);

              const tbBtn = document.createElement("button");
              tbBtn.textContent = "â±ï¸ Set Timer";
              tbBtn.onclick = () => setTaskTimer(id);

              dv.append(ap, tbBtn);
            }

            td.appendChild(dv);
          });
        }

        if (isParent) {
          const eb = document.createElement("button");
          eb.textContent = "âœï¸ Edit";
          eb.style.marginTop = "5px";
          eb.style.fontSize = "12px";
          eb.onclick = () => {
            const cur = (chores[todayName]?.[name]||[]).join(", ");
            const val = prompt(`Edit ${name} on ${todayName}:`, cur);
            if (val !== null) {
              const arr = val.split(",").map(t => t.trim()).filter(t => t);
              chores[todayName][name] = arr;
              db.ref(`weeklyChores/${todayName}/${name}`).set(arr);
            }
          };
          td.appendChild(eb);
        }

        tr.appendChild(td);
      });

      tb.appendChild(tr);
      Object.entries(taskStatuses).forEach(([id, st]) => updateTaskUI(id, st));
    }

    function renderFullChores() {
      const tb = document.getElementById("chore-body");
      const now = new Date();
      const todayName = now.toLocaleDateString('en-US', { weekday: 'long' });
      const fullDate = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      document.getElementById("dateLabel").textContent = `All Tasks (Today: ${todayName}, ${fullDate})`;
      tb.innerHTML = "";

      ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"].forEach(day => {
        const tr = document.createElement("tr");
        if (day === todayName) tr.classList.add("highlight-row");
        const tdDay = document.createElement("td");
        tdDay.textContent = day === todayName ? `${day} (${fullDate})` : day;
        tr.appendChild(tdDay);

        ["Jacob","Jalyna","Josh","Jeremy"].forEach(name => {
          const td = document.createElement("td");
          const list = chores[day]?.[name] || [];
          if (!list.length) {
            td.innerHTML = "<em>Free</em>";
          } else {
            list.forEach((task, i) => {
              const id = `${name.toLowerCase()}-${day.toLowerCase()}-${i}`;
              const dv = document.createElement("div");
              dv.className = "task";

              const prio = priorities[id] || "Medium";
              dv.classList.add(`priority-${prio}`);

              const lb = document.createElement("label");
              const cb = document.createElement("input");
              cb.type = "checkbox";
              cb.id = `${id}-checkbox`;
              cb.onchange = () => toggleTask(cb, id);
              lb.append(cb, document.createTextNode(task));

              const sel = document.createElement("select");
              sel.className = "priority-select";
              ["Low","Medium","High"].forEach(level => {
                const opt = document.createElement("option");
                opt.value = level;
                opt.textContent = level;
                if (level === prio) opt.selected = true;
                sel.append(opt);
              });
              sel.onchange = () => prioritiesRef.child(id).set(sel.value);

              const ts = document.createElement("span");
              ts.id = `${id}-timer`;
              ts.className = "timer";
              const ss = document.createElement("span");
              ss.id = `${id}-status`;

              dv.append(lb, sel, ts, ss);

              if (isParent) {
                const ap = document.createElement("button");
                ap.id = `${id}-approve`;
                ap.textContent = "Approve";
                ap.style.display = "none";
                ap.onclick = () => approveTask(id);

                const tbBtn = document.createElement("button");
                tbBtn.textContent = "â±ï¸ Set Timer";
                tbBtn.onclick = () => setTaskTimer(id);

                dv.append(ap, tbBtn);
              }

              td.appendChild(dv);
            });
          }

          if (isParent) {
            const eb = document.createElement("button");
            eb.textContent = "âœï¸ Edit";
            eb.style.marginTop = "5px";
            eb.style.fontSize = "12px";
            eb.onclick = () => {
              const cur = (chores[day]?.[name]||[]).join(", ");
              const val = prompt(`Edit ${name} on ${day}:`, cur);
              if (val !== null) {
                const arr = val.split(",").map(t => t.trim()).filter(t => t);
                chores[day][name] = arr;
                db.ref(`weeklyChores/${day}/${name}`).set(arr);
              }
            };
            td.appendChild(eb);
          }

          tr.appendChild(td);
        });

        tb.appendChild(tr);
      });

      Object.entries(taskStatuses).forEach(([id, st]) => updateTaskUI( id, st ));
    }

    function renderChores() {
      if (fullView && isParent) renderFullChores();
      else renderTodayChores();
    }

    function updateRecyclingNote() {
      const note = document.getElementById("recyclingNote");
      const now = new Date(), wed = new Date(now);
      wed.setDate(wed.getDate() + ((3 - now.getDay() + 7) % 7));
      wed.setHours(6,0,0,0);
      const pd = now < wed ? wed : new Date(wed.getTime() + 7*86400000);
      const start = new Date("2025-05-15T06:00:00");
      const types = ["Paper/Cardboard","Plastic/Metal"];
      const weeks = Math.round((pd - start) / (7*86400000));
      const type = types[weeks % 2];
      const d = pd.toLocaleDateString('en-US',{month:'long',day:'numeric'});
      note.innerHTML = `â™»ï¸ Next recycling (${d}): <strong>${type}</strong>`;
    }

    async function fetchWeatherToday() {
      try {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,'0');
        const dd = String(now.getDate()).padStart(2,'0');
        const todayStr = `${yyyy}-${mm}-${dd}`;
        const url = new URL("https://api.open-meteo.com/v1/forecast");
        url.searchParams.set("latitude", 40.8485);
        url.searchParams.set("longitude", -73.149);
        url.searchParams.set("daily", "temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode");
        url.searchParams.set("temperature_unit", "fahrenheit");
        url.searchParams.set("timezone", "America/New_York");
        url.searchParams.set("start_date", todayStr);
        url.searchParams.set("end_date", todayStr);

        const res = await fetch(url);
        const data = await res.json();
        const date = data.daily.time[0];
        const maxF = Math.round(data.daily.temperature_2m_max[0]);
        const minF = Math.round(data.daily.temperature_2m_min[0]);
        const pct  = data.daily.precipitation_probability_max[0];
        const code = data.daily.weathercode[0];
        const icons = {
          0:"â˜€ï¸",1:"ğŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ğŸŒ«ï¸",48:"ğŸŒ«ï¸",
          51:"ğŸŒ¦ï¸",53:"ğŸŒ¦ï¸",55:"ğŸŒ§ï¸",56:"ğŸŒ§ï¸",57:"ğŸŒ§ï¸",
          61:"ğŸŒ§ï¸",63:"ğŸŒ§ï¸",65:"ğŸŒ§ï¸",66:"ğŸŒ§ï¸",67:"ğŸŒ§ï¸",
          71:"â„ï¸",73:"â„ï¸",75:"â„ï¸",77:"â„ï¸",80:"ğŸŒ¦ï¸",
          81:"ğŸŒ¦ï¸",82:"ğŸŒ¦ï¸",95:"â›ˆï¸",96:"â›ˆï¸",99:"â›ˆï¸"
        };
        const icon = icons[code] || "ğŸŒ¡ï¸";
        const [y,mo,da] = date.split("-").map(Number);
        const dLocal = new Date(y,mo-1,da);
        const name = dLocal.toLocaleDateString("en-US",{weekday:"long"});
        document.getElementById("weatherAlert").innerHTML =
          `<span>${icon}</span> <strong>${name} (${date}):</strong>` +
          ` High ${maxF}Â°F, Low ${minF}Â°F, ${pct}% precip`;
      } catch(e) {
        console.error(e);
        document.getElementById("weatherAlert").textContent = "Weather unavailable.";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (isParent) {
        document.getElementById("viewToggleSection").style.display = "block";
        document.getElementById("view-toggle-checkbox")
          .addEventListener("change", e => {
            fullView = e.target.checked;
            renderChores();
          });
      }
      prioritiesRef.on("value", snap => {
        priorities = snap.val() || {};
        renderChores();
      });
      db.ref("weeklyChores").on("value", snap => {
        chores = snap.val() || {};
        renderChores();
      });
      db.ref("tasks").on("value", snap => {
        taskStatuses = snap.val() || {};
        renderChores();
      });
      db.ref("timers").on("value", snap => {
        timers = snap.val() || {};
        setInterval(updateTimerDisplays, 1000);
      });
      updateRecyclingNote();
      fetchWeatherToday();
    });
  </script>
</body>
</html>
