<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Tasks - Blue Theme Responsive</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

  <style>
    /* Root Variables */
    :root {
      --bg-light: #e3f2fd;
      --bg-dark: #0d47a1;
      --text-light: #212121;
      --text-dark: #e3f2fd;
      --accent: #2196f3;
      --accent-dark: #42a5f5;
      --border: #bbdefb;
      --highlight: rgba(33,150,243,0.1);
      --card-bg-light: #fff;
      --card-bg-dark: #2a2a2a;
      --shadow: rgba(0,0,0,0.1);
    }
    /* Global Styles */
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--bg-light);
      color: var(--text-light);
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    h1 {
      text-align: center;
      margin: 1rem 0;
      font-weight: 500;
      letter-spacing: 1px;
    }

    /* Table Container */
    .table-container {
      max-width: 1200px;
      margin: 0 auto 1rem;
      background: var(--card-bg-light);
      border-radius: 8px;
      box-shadow: 0 8px 16px var(--shadow);
      overflow-x: auto;
    }
    body.dark .table-container {
      background: var(--card-bg-dark);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    thead {
      background: var(--accent);
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }
    tr:nth-child(even) td {
      background: rgba(0, 0, 0, 0.02);
    }
    .highlight-row td {
      background: var(--highlight) !important;
    }

    /* Task Items */
    .task {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--card-bg-light);
      border-radius: 6px;
      padding: 6px 10px;
      margin: 4px 0;
      box-shadow: 0 4px 8px var(--shadow);
      transition: transform 0.2s, background 0.2s;
    }
    body.dark .task {
      background: var(--card-bg-dark);
    }
    .task:hover {
      transform: translateY(-2px);
      background: var(--highlight);
    }
    .task button {
      padding: 4px 8px;
      font-size: 12px;
      margin-left: 4px;
    }
    .timer {
      font-size: 12px;
      color: #c00;
      margin-left: 8px;
    }
    .approved {
      color: var(--accent);
      font-weight: 600;
    }

    /* Notes */
    .recycling-note,
    .garbage-note {
      max-width: 1200px;
      margin: 8px auto;
      padding: 8px;
      background: var(--card-bg-light);
      box-shadow: 0 2px 4px var(--shadow);
      border-radius: 4px;
      text-align: center;
    }
    body.dark .recycling-note,
    body.dark .garbage-note {
      background: var(--card-bg-dark);
      color: var(--text-dark);
    }

    /* Footer */
    .footer-note {
      text-align: center;
      margin: 16px;
      font-size: 14px;
      opacity: 0.7;
    }

    /* Buttons */
    .core-btn {
      position: relative;
      overflow: hidden;
      padding: 10px 20px;
      margin: 0 4px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .core-btn:hover {
      background: var(--accent-dark);
    }
    .core-btn::after {
      content: "";
      position: absolute;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.4);
      border-radius: 50%;
      transform: translate(-50%,-50%) scale(0);
      pointer-events: none;
      transition: width 0.4s, height 0.4s, transform 0.4s;
    }
    .core-btn:active::after {
      width: 200px;
      height: 200px;
      top: var(--y);
      left: var(--x);
      transform: translate(-50%,-50%) scale(1);
      transition: 0s;
    }

    /* Weather Alert */
    .weather-alert {
      max-width: 400px;
      margin: 16px auto;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--card-bg-light);
      border-left: 6px solid var(--accent);
      box-shadow: 0 4px 12px var(--shadow);
      border-radius: 6px;
    }
    body.dark .weather-alert {
      background: var(--card-bg-dark);
    }
    .weather-icon {
      font-size: 2rem;
    }
  </style>
</head>
<body>
  <h1>Family Tasks</h1>
  <label style="position:absolute; top:16px; right:16px; display:flex; align-items:center;">
    <input type="checkbox" id="toggle-checkbox" onchange="toggleTheme()">
    <span id="mode-label" style="margin-left:6px;">üåô Dark</span>
  </label>

  <div class="weather-alert">
    <span class="weather-icon">‚õÖ</span>
    <div>
      <strong id="weather-day">Loading</strong><br>
      <span id="weather-info">Loading...</span>
    </div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Day</th>
          <th>Jacob</th>
          <th>Jalyna</th>
          <th>Josh</th>
          <th>Jeremy</th>
        </tr>
      </thead>
      <tbody id="chore-body"></tbody>
    </table>
    <div style="text-align:center; margin:12px;">
      <button class="core-btn" onclick="rotateChores()">üîÑ Rotate Tasks</button>
      <button class="core-btn" onclick="resetAllTasks()">üîÅ Reset All</button>
    </div>
  </div>

  <div class="recycling-note">‚ôªÔ∏è Loading recycling schedule...</div>
  <div class="garbage-note">üóëÔ∏è Loading garbage instructions...</div>

  <div class="footer-note">‚úÖ Complete tasks to regain Wi-Fi privileges. Parent approval required.</div>

  <script>
    // Ripple effect for buttons
    document.querySelectorAll('.core-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        btn.style.setProperty('--x', e.offsetX + 'px');
        btn.style.setProperty('--y', e.offsetY + 'px');
      });
    });

    // Dark/Light toggle
    function toggleTheme() {
      document.body.classList.toggle('dark');
      const dark = document.body.classList.contains('dark');
      document.getElementById('mode-label').textContent = dark ? '‚òÄÔ∏è Light' : 'üåô Dark';
    }

    // Firebase initialization
    const firebaseConfig = {
      apiKey: "AIzaSyA6hkZDTQrqhS6Wcm9z8ADm5It-wck7U8",
      authDomain: "chores-c86f4.firebaseapp.com",
      databaseURL: "https://chores-c86f4-default-rtdb.firebaseio.com",
      projectId: "chores-c86f4",
      storageBucket: "chores-c86f4.appspot.com",
      messagingSenderId: "503520134350",
      appId: "1:503520134350:web:0ce4fc7c3c011eaa0cbc9f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const isParent = new URLSearchParams(window.location.search).get('user') === 'parent';

    let chores = {};
    let taskStatuses = {};
    let timers = {};

    // Format timer
    function formatTime(ms) {
      const s = Math.max(0, Math.floor(ms / 1000));
      const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }
    function updateTimers() {
      for (const id in timers) {
        const el = document.getElementById(id + '-timer');
        if (el) {
          const left = timers[id] - Date.now();
          el.textContent = left > 0 ? `‚è≥ ${formatTime(left)}` : '';
        }
      }
    }
    setInterval(updateTimers, 1000);

    // Set timer by parent
    function setTaskTimer(id) {
      if (!isParent) return;
      const mins = parseInt(prompt('Set timer (minutes):'));
      if (!isNaN(mins) && mins > 0) {
        db.ref('timers/' + id).set(Date.now() + mins * 60000);
      }
    }

    // Sync and update task UI
    function syncTask(id, status) { db.ref('tasks/' + id).set(status); }
    function updateTaskUI(id, status) {
      const cb = document.getElementById(id + '-checkbox');
      const st = document.getElementById(id + '-status');
      const btn = document.getElementById(id + '-approve');
      if (!cb || !st) return;
      if (status === 'approved') {
        cb.checked = true; cb.disabled = true;
        st.textContent = '‚úÖ';
        if (btn) btn.style.display = 'none';
      } else if (status === 'pending') {
        cb.checked = true; cb.disabled = false;
        st.textContent = '‚è≥';
        if (btn && isParent) btn.style.display = 'inline-block';
      } else {
        cb.checked = false; cb.disabled = false;
        st.textContent = '';
        if (btn) btn.style.display = 'none';
      }
    }
    function toggleTask(cb, id) {
      const status = cb.checked ? 'pending' : '';
      syncTask(id, status);
      updateTaskUI(id, status);
    }
    function approveTask(id) {
      if (!isParent) return;
      syncTask(id, 'approved');
      updateTaskUI(id, 'approved');
    }

    // Reset chores
    function resetAllTasks() {
      if (!isParent) return;
      if (confirm('Reset all tasks?')) {
        db.ref('tasks').remove();
        location.reload();
      }
    }

    // Rotate chores forward by one day
    function rotateChores() {
      if (!isParent) return;
      if (!confirm('Rotate chores forward one day?')) return;
      const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
      const newMap = {};
      days.forEach((day, i) => {
        const prev = days[(i + 6) % 7];
        newMap[day] = chores[prev] || {};
      });
      db.ref('weeklyChores').set(newMap);
    }

    // Edit chores
    function editTasks(day, name) {
      if (!isParent) return;
      const current = (chores[day]?.[name] || []).join(', ');
      const input = prompt(`Edit tasks for ${name} on ${day}:`, current);
      if (input !== null) {
        const arr = input.split(',').map(t => t.trim()).filter(t => t);
        chores[day][name] = arr;
        db.ref(`weeklyChores/${day}/${name}`).set(arr);
      }
    }

    // Update recycling and garbage notes
    function updateRecycling() {
      const r = document.querySelector('.recycling-note');
      const now = new Date(), wed = new Date(now);
      wed.setDate(wed.getDate() + ((3 - now.getDay() + 7) % 7));
      wed.setHours(6,0,0,0);
      const pd = now < wed ? wed : new Date(wed.getTime() + 7*86400000);
      const start = new Date('2025-05-15T06:00:00');
      const types = ['Paper/Cardboard','Plastic/Metal'];
      const weeks = Math.round((pd - start)/(7*86400000));
      const type = types[weeks % 2];
      const ds = pd.toLocaleDateString('en-US',{month:'long',day:'numeric'});
      r.innerHTML = `‚ôªÔ∏è <strong>Recycling:</strong> Next pickup for <strong>${type}</strong> on ${ds}`;
      const g = document.querySelector('.garbage-note');
      g.innerHTML = `üóëÔ∏è <strong>Garbage:</strong> Take out before 9:00 PM the night before pickup.`;
    }

    // Fetch today‚Äôs weather
    const weatherConfig = { latitude: 40.8485, longitude: -73.149, timezone: 'America/New_York' };
    const weatherIcons = {
      0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´Ô∏è',48:'üå´Ô∏è',51:'üå¶Ô∏è',53:'üå¶Ô∏è',55:'üåßÔ∏è',56:'üåßÔ∏è',57:'üåßÔ∏è',61:'üåßÔ∏è',63:'üåßÔ∏è',65:'üåßÔ∏è',66:'üåßÔ∏è',67:'üåßÔ∏è',71:'‚ùÑÔ∏è',73:'‚ùÑÔ∏è',75:'‚ùÑÔ∏è',77:'‚ùÑÔ∏è',80:'üå¶Ô∏è',81:'üå¶Ô∏è',82:'üå¶Ô∏è',95:'‚õàÔ∏è',96:'‚õàÔ∏è',99:'‚õàÔ∏è'
    };
    async function fetchWeather() {
      try {
        const now = new Date();
        const yyyy = now.getFullYear(), mm = String(now.getMonth()+1).padStart(2,'0'), dd = String(now.getDate()).padStart(2,'0');
        const dateStr = `${yyyy}-${mm}-${dd}`;
        const url = new URL('https://api.open-meteo.com/v1/forecast');
        url.searchParams.set('latitude', weatherConfig.latitude);
        url.searchParams.set('longitude', weatherConfig.longitude);
        url.searchParams.set('daily','temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode');
        url.searchParams.set('temperature_unit','fahrenheit');
        url.searchParams.set('timezone', weatherConfig.timezone);
        url.searchParams.set('start_date', dateStr);
        url.searchParams.set('end_date', dateStr);
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Weather fetch failed ${res.status}`);
        const data = await res.json();
        const code = data.daily.weathercode[0];
        const icon = weatherIcons[code] || 'üå°Ô∏è';
        const dayName = new Date(data.daily.time[0]).toLocaleDateString('en-US',{weekday:'long'});
        const hi = Math.round(data.daily.temperature_2m_max[0]);
        const lo = Math.round(data.daily.temperature_2m_min[0]);
        document.getElementById('weather-day').textContent = dayName;
        document.getElementById('weather-info').textContent = `${icon} High ${hi}¬∞F, Low ${lo}¬∞F`;
      } catch (e) {
        console.error('Weather error:', e);
      }
    }

    // Render chores table
    function renderChores() {
      const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
      const names = ['Jacob','Jalyna','Josh','Jeremy'];
      const tb = document.getElementById('chore-body');
      tb.innerHTML = '';
      const today = new Date().toLocaleDateString('en-US',{weekday:'long'});
      days.forEach(day => {
        const tr = document.createElement('tr');
        if (day === today) tr.classList.add('highlight-row');
        const tdDay = document.createElement('td');
        tdDay.textContent = day;
        tr.append(tdDay);
        names.forEach(name => {
          const td = document.createElement('td');
          const list = chores[day]?.[name] || [];
          if (!list.length) {
            td.innerHTML = '<em>Free</em>';
          } else {
            list.forEach((task,i) => {
              const id = `${name}-${day}-${i}`;
              const div = document.createElement('div'); div.className = 'task';
              const cb = document.createElement('input');
              cb.type = 'checkbox'; cb.id = id + '-checkbox';
              cb.onchange = () => toggleTask(cb, id);
              const lb = document.createElement('label');
              lb.htmlFor = id + '-checkbox'; lb.textContent = task;
              const ts = document.createElement('span');
              ts.id = id + '-timer'; ts.className = 'timer';
              div.append(cb, lb, ts);
              if (isParent) {
                const ap = document.createElement('button');
                ap.id = id + '-approve'; ap.textContent = 'Approve';
                ap.onclick = () => approveTask(id);
                div.append(ap);
                const tp = document.createElement('button');
                tp.textContent = '‚è±Ô∏è'; tp.onclick = () => setTaskTimer(id);
                div.append(tp);
              }
              td.append(div);
            });
          }
          if (isParent) {
            const editBtn = document.createElement('button');
            editBtn.textContent = '‚úèÔ∏è';
            editBtn.onclick = () => editTasks(day, name);
            td.append(editBtn);
          }
          tr.append(td);
        });
        tb.append(tr);
      });
      Object.entries(taskStatuses).forEach(([id,status]) => updateTaskUI(id,status));
    }

    // Initialize listeners
    document.addEventListener('DOMContentLoaded', () => {
      db.ref('weeklyChores').on('value', snap => { chores = snap.val() || {}; renderChores(); });
      db.ref('tasks').on('value', snap => { taskStatuses = snap.val() || {}; renderChores(); });
      db.ref('timers').on('value', snap => { timers = snap.val() || {}; updateTimers(); });
      updateRecycling();
      fetchWeather();
    });
  </script>
</body>
</html>
